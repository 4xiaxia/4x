# AIClient-2-API é¡¹ç›®æ–½å·¥å›¾çº¸

> ğŸ  **æˆ¿å±‹è£…ä¿®ç¿»æ–°ç»´æŠ¤çš„æ–½å·¥å›¾çº¸**
>
> æœ¬æ–‡æ¡£æä¾›é¡¹ç›®çš„å®Œæ•´æŠ€æœ¯æ¶æ„ã€ä»£ç ä½ç½®ã€æ ¸å¿ƒåŠŸèƒ½å’Œç»´æŠ¤æŒ‡å—ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æˆ¿å±‹åœ°åŸºç»“æ„ï¼ˆè¯­è¨€ã€æ¡†æ¶ã€æ¶æ„ï¼‰](#æˆ¿å±‹åœ°åŸºç»“æ„)
2. [æ°´ç”µå¸ƒçº¿ï¼ˆAPI è·¯ç”±ã€é’©å­ï¼‰](#æ°´ç”µå¸ƒçº¿)
3. [å¼€å…³æ§åˆ¶ï¼ˆä¸­ç»§å™¨ã€ä¸­å°ã€è£…é¥°å™¨ï¼‰](#å¼€å…³æ§åˆ¶)
4. [å®¶å…·è½¯è£…ï¼ˆUIã€å‰ç«¯ï¼‰](#å®¶å…·è½¯è£…)
5. [æ–½å·¥é—®é¢˜æ¸…å•](#æ–½å·¥é—®é¢˜æ¸…å•)
6. [ç»´æŠ¤æŒ‡å—](#ç»´æŠ¤æŒ‡å—)

---

## ğŸ—ï¸ æˆ¿å±‹åœ°åŸºç»“æ„ï¼ˆè¯­è¨€ã€æ¡†æ¶ã€æ¶æ„ï¼‰

### æŠ€æœ¯æ ˆï¼ˆå»ºç­‘ææ–™ï¼‰

**åç«¯æ¡†æ¶**ï¼š
- **æ ¸å¿ƒè¯­è¨€**ï¼šNode.js â‰¥ 18.0.0ï¼ˆæ¨è 20.0.0+ï¼‰
- **æ¨¡å—ç³»ç»Ÿ**ï¼šESM (ECMAScript Modules)
- **HTTP æœåŠ¡å™¨**ï¼šåŸç”Ÿ `http` æ¨¡å—
- **å¼‚æ­¥å¤„ç†**ï¼šAsync/Await + Promise

**æ ¸å¿ƒä¾èµ–åŒ…**ï¼ˆpackage.json:3-18ï¼‰ï¼š

| åŒ…å | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| `axios` | ^1.13.5 | HTTP å®¢æˆ·ç«¯ |
| `google-auth-library` | ^10.1.0 | Google OAuth è®¤è¯ |
| `undici` | ^7.18.2 | HTTP/1.1 å®¢æˆ·ç«¯ |
| `ws` | ^8.19.0 | WebSocket æ”¯æŒ |
| `multer` | ^2.0.2 | æ–‡ä»¶ä¸Šä¼ å¤„ç† |
| `lodash` | ^4.17.23 | å·¥å…·å‡½æ•°åº“ |
| `deepmerge` | ^4.3.1 | å¯¹è±¡æ·±åº¦åˆå¹¶ |

### æ¶æ„è®¾è®¡ï¼ˆæˆ¿å±‹ç»“æ„ï¼‰

#### 1. åŒå±‚è¿›ç¨‹æ¶æ„ï¼ˆæ‰¿é‡å¢™ï¼‰

**ä¸»è¿›ç¨‹**ï¼ˆMaster Processï¼‰ï¼š
- **æ–‡ä»¶ä½ç½®**ï¼š`src/core/master.js:1-403`
- **ç«¯å£**ï¼š3100ï¼ˆç®¡ç†ç«¯å£ï¼‰
- **èŒè´£**ï¼š
  - ç®¡ç†å­è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ
  - æä¾›è¿›ç¨‹ç®¡ç†å’Œå¥åº·æ£€æŸ¥
  - è‡ªåŠ¨é‡å¯å­è¿›ç¨‹ï¼ˆæœ€å¤š 10 æ¬¡å°è¯•ï¼‰

**å­è¿›ç¨‹**ï¼ˆWorker Processï¼‰ï¼š
- **æ–‡ä»¶ä½ç½®**ï¼š`src/services/api-server.js:1-365`
- **ç«¯å£**ï¼š3000ï¼ˆæœåŠ¡ç«¯å£ï¼‰
- **èŒè´£**ï¼š
  - å¤„ç† API è¯·æ±‚
  - åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
  - å¯åŠ¨ HTTP æœåŠ¡å™¨

**è¿›ç¨‹é€šä¿¡**ï¼š
- ä½¿ç”¨ `child_process.fork()` åˆ›å»ºå­è¿›ç¨‹
- é€šè¿‡ IPC (Inter-Process Communication) é€šä¿¡
- æ”¯æŒæ¶ˆæ¯ä¼ é€’å’Œäº‹ä»¶ç›‘å¬

#### 2. æ’ä»¶ç³»ç»Ÿï¼ˆç”µæ°”å¸ƒçº¿ï¼‰

**æ’ä»¶ç®¡ç†å™¨**ï¼š`src/core/plugin-manager.js:1-549`

**æ’ä»¶ç±»å‹**ï¼š
- **AUTH**ï¼šè®¤è¯æ’ä»¶ï¼Œå‚ä¸è®¤è¯æµç¨‹
- **MIDDLEWARE**ï¼šæ™®é€šä¸­é—´ä»¶

**æ’ä»¶ä¼˜å…ˆçº§**ï¼š
- æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ
- å†…ç½®æ’ä»¶æ’åœ¨æœ€åï¼ˆ`_builtin: true`ï¼‰

**æ’ä»¶ç”Ÿå‘½å‘¨æœŸ**ï¼š

```mermaid
graph LR
    A[æ’ä»¶æ³¨å†Œ] --> B[æ’ä»¶åˆå§‹åŒ–]
    B --> C[è®¤è¯æ‰§è¡Œ]
    C --> D[ä¸­é—´ä»¶æ‰§è¡Œ]
    D --> E[è·¯ç”±æ‰§è¡Œ]
    E --> F[é’©å­æ‰§è¡Œ]
```

**å†…ç½®æ’ä»¶**ï¼š
- `default-auth`ï¼šé»˜è®¤ API Key è®¤è¯ï¼ˆsrc/plugins/default-auth/index.js:1-94ï¼‰
- `ai-monitor`ï¼šAI æ¥å£ç›‘æ§ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰

#### 3. ç­–ç•¥æ¨¡å¼ï¼ˆæˆ·å‹è®¾è®¡ï¼‰

**æä¾›å•†ç­–ç•¥å·¥å‚**ï¼š`src/utils/provider-strategies.js:1-64`

**æ”¯æŒçš„æä¾›å•†ç±»å‹**ï¼š
- `gemini-cli-oauth`ï¼šGemini CLIï¼ˆOAuthï¼‰
- `gemini-antigravity`ï¼šGemini Antigravity
- `claude-kiro-oauth`ï¼šClaude Kiroï¼ˆOAuthï¼‰
- `claude-custom`ï¼šClaude è‡ªå®šä¹‰
- `openai-custom`ï¼šOpenAI è‡ªå®šä¹‰
- `codex-custom`ï¼šCodex è‡ªå®šä¹‰
- `iflow-cli-oauth`ï¼šiFlow CLIï¼ˆOAuthï¼‰
- `qwen-cli-oauth`ï¼šQwen CLIï¼ˆOAuthï¼‰

#### 4. é€‚é…å™¨æ¨¡å¼ï¼ˆæ¥å£é€‚é…ï¼‰

**æä¾›å•†é€‚é…å™¨**ï¼š`src/providers/adapter.js:1-692`

**è½¬æ¢å™¨å·¥å‚**ï¼š`src/converters/ConverterFactory.js:1-165`

**åè®®è½¬æ¢**ï¼š

```mermaid
graph LR
    A[OpenAI æ ¼å¼] --> B[è¯·æ±‚è½¬æ¢]
    C[Claude æ ¼å¼] --> B
    D[Gemini æ ¼å¼] --> B
    B --> E[æä¾›å•† API]
    E --> F[å“åº”è½¬æ¢]
    F --> G[ç»Ÿä¸€æ ¼å¼]
```

**æ”¯æŒçš„åè®®**ï¼š
- OpenAIï¼š`/v1/*`
- Claudeï¼š`/v1/messages`
- Geminiï¼š`/v1beta/*`
- Ollamaï¼š`/ollama/api/*`

---

## ğŸ’§ æ°´ç”µå¸ƒçº¿ï¼ˆAPI è·¯ç”±ã€é’©å­ï¼‰

### API è·¯ç”±è®¾è®¡ï¼ˆæ°´ç®¡èµ°å‘ï¼‰

#### 1. ç®¡ç†åå° APIï¼ˆæ°´ç®¡ä¸»çº¿è·¯ï¼‰

**è®¤è¯ç›¸å…³**ï¼š
```
POST /api/login              - ç™»å½•
GET  /api/health             - å¥åº·æ£€æŸ¥ï¼ˆå…è®¤è¯ï¼‰
GET  /api/events            - Server-Sent Eventsï¼ˆå…è®¤è¯ï¼‰
```

**é…ç½®ç®¡ç†**ï¼š
```
POST /api/admin-password      - æ›´æ–°ç®¡ç†å‘˜å¯†ç 
GET  /api/config             - è·å–é…ç½®
POST /api/config             - æ›´æ–°é…ç½®
POST /api/reload-config      - é‡æ–°åŠ è½½é…ç½®
```

**ç³»ç»Ÿç®¡ç†**ï¼š
```
GET  /api/system             - è·å–ç³»ç»Ÿä¿¡æ¯
GET  /api/system/download-log      - ä¸‹è½½ä»Šæ—¥æ—¥å¿—
POST /api/system/clear-log         - æ¸…é™¤ä»Šæ—¥æ—¥å¿—
POST /api/restart-service          - é‡å¯æœåŠ¡
GET  /api/service-mode             - è·å–æœåŠ¡æ¨¡å¼
```

**æä¾›å•†ç®¡ç†**ï¼š
```
GET  /api/providers                      - è·å–æä¾›å•†åˆ—è¡¨
GET  /api/providers/{type}              - è·å–ç‰¹å®šç±»å‹è¯¦æƒ…
GET  /api/provider-models               - è·å–æ‰€æœ‰å¯ç”¨æ¨¡å‹
GET  /api/provider-models/{type}        - è·å–ç‰¹å®šç±»å‹æ¨¡å‹
POST /api/providers                     - æ·»åŠ æ–°æä¾›å•†
PUT  /api/providers/{type}/{uuid}      - æ›´æ–°æä¾›å•†
DELETE /api/providers/{type}/{uuid}     - åˆ é™¤æä¾›å•†
POST /api/providers/{type}/reset-health             - é‡ç½®å¥åº·çŠ¶æ€
POST /api/providers/{type}/health-check            - æ‰§è¡Œå¥åº·æ£€æŸ¥
DELETE /api/providers/{type}/delete-unhealthy     - åˆ é™¤ä¸å¥åº·çš„
POST /api/providers/{type}/refresh-unhealthy-uuids - åˆ·æ–° UUID
POST /api/providers/{type}/{uuid}/disable        - ç¦ç”¨æä¾›å•†
POST /api/providers/{type}/{uuid}/enable          - å¯ç”¨æä¾›å•†
POST /api/providers/{type}/{uuid}/refresh-uuid    - åˆ·æ–° UUID
POST /api/providers/{type}/generate-auth-url      - ç”Ÿæˆæˆæƒ URL
```

**OAuth ç®¡ç†**ï¼š
```
POST /api/oauth/manual-callback        - æ‰‹åŠ¨ OAuth å›è°ƒ
POST /api/kiro/batch-import-tokens    - æ‰¹é‡å¯¼å…¥ Kiro Token
POST /api/gemini/batch-import-tokens  - æ‰¹é‡å¯¼å…¥ Gemini Token
POST /api/kiro/import-aws-credentials  - å¯¼å…¥ AWS å‡­è¯
```

**é…ç½®æ–‡ä»¶ç®¡ç†**ï¼š
```
POST /api/upload-oauth-credentials           - ä¸Šä¼  OAuth å‡­è¯
GET  /api/upload-configs                    - è·å–é…ç½®æ–‡ä»¶åˆ—è¡¨
GET  /api/upload-configs/view/{path}        - æŸ¥çœ‹é…ç½®æ–‡ä»¶
DELETE /api/upload-configs/delete/{path}     - åˆ é™¤é…ç½®æ–‡ä»¶
GET  /api/upload-configs/download-all       - ä¸‹è½½æ‰€æœ‰é…ç½®
DELETE /api/upload-configs/delete-unbound    - åˆ é™¤æœªç»‘å®šçš„
```

**ä½¿ç”¨é‡æŸ¥è¯¢**ï¼š
```
GET  /api/usage                         - è·å–æ‰€æœ‰æä¾›å•†ä½¿ç”¨é‡
GET  /api/usage/supported-providers      - è·å–æ”¯æŒçš„æä¾›å•†
GET  /api/usage/{type}                  - è·å–ç‰¹å®šæä¾›å•†ä½¿ç”¨é‡
```

**æ›´æ–°ç®¡ç†**ï¼š
```
GET  /api/check-update  - æ£€æŸ¥æ›´æ–°
POST /api/update       - æ‰§è¡Œæ›´æ–°
```

**æ’ä»¶ç®¡ç†**ï¼š
```
GET  /api/plugins               - è·å–æ’ä»¶åˆ—è¡¨
POST /api/plugins/{name}/toggle - åˆ‡æ¢æ’ä»¶çŠ¶æ€
```

**å¿«é€Ÿæ“ä½œ**ï¼š
```
POST /api/quick-link-provider - å¿«é€Ÿå…³è”æä¾›å•†
```

#### 2. æ ¸å¿ƒ AI APIï¼ˆæ°´ç®¡æ”¯çº¿ï¼‰

**OpenAI å…¼å®¹**ï¼š
```
POST /v1/chat/completions    - èŠå¤©å®Œæˆ
POST /v1/responses           - å“åº”ç”Ÿæˆ
GET  /v1/models             - æ¨¡å‹åˆ—è¡¨
```

**Gemini å…¼å®¹**ï¼š
```
POST /v1beta/models/{model}:generateContent      - ç”Ÿæˆå†…å®¹
POST /v1beta/models/{model}:streamGenerateContent - æµå¼ç”Ÿæˆ
GET  /v1beta/models                           - æ¨¡å‹åˆ—è¡¨
```

**Claude å…¼å®¹**ï¼š
```
POST /v1/messages       - æ¶ˆæ¯
```

**Ollama å…¼å®¹**ï¼š
```
GET  /ollama/api/tags                - æ¨¡å‹åˆ—è¡¨
POST /ollama/api/chat                - èŠå¤©
POST /ollama/api/generate            - ç”Ÿæˆ
POST /ollama/api/show                - æ˜¾ç¤ºæ¨¡å‹è¯¦æƒ…
```

**Token è®¡ç®—**ï¼š
```
POST /count_tokens  - è®¡ç®— Token æ•°é‡
```

### é’©å­ç³»ç»Ÿï¼ˆç”µè·¯æ§åˆ¶ï¼‰

**é’©å­ç±»å‹**ï¼š

1. **onBeforeRequest**ï¼šè¯·æ±‚å‰
2. **onAfterResponse**ï¼šå“åº”å
3. **onContentGenerated**ï¼šå†…å®¹ç”Ÿæˆå
4. **onStreamChunk**ï¼šæµå¼åˆ†å—
5. **onInternalRequestConverted**ï¼šå†…éƒ¨è¯·æ±‚è½¬æ¢

**é’©å­æ‰§è¡Œæ—¶æœº**ï¼š

```mermaid
sequenceDiagram
    participant Client
    participant Handler
    participant Auth
    participant Middleware
    participant Provider
    participant Converter

    Client->>Handler: è¯·æ±‚
    Handler->>Auth: è®¤è¯æ’ä»¶
    Handler->>Middleware: ä¸­é—´ä»¶æ’ä»¶
    Middleware->>Provider: è°ƒç”¨æä¾›å•†
    Provider->>Converter: è½¬æ¢å“åº”
    Converter->>Middleware: onAfterResponse
    Middleware->>Client: è¿”å›å“åº”
```

### æ•°æ®æµå‘ï¼ˆæ°´æµåŠ¨è·¯å¾„ï¼‰

**å®Œæ•´è¯·æ±‚æµç¨‹**ï¼š

```mermaid
graph TD
    A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[request-handler.js]
    B --> C{é™æ€æ–‡ä»¶?}
    C -->|æ˜¯| D[serveStaticFiles]
    C -->|å¦| E{æ’ä»¶è·¯ç”±?}
    E -->|æ˜¯| F[executeRoutes]
    E -->|å¦| G{UI API?}
    G -->|æ˜¯| H[handleUIApiRequests]
    G -->|å¦| I{OAuth?}
    I -->|æ˜¯| J[handleOAuthRequest]
    I -->|å¦| K{Ollama?}
    K -->|æ˜¯| L[handleOllamaRequest]
    K -->|å¦| M{è®¤è¯æ£€æŸ¥}
    M -->|å¤±è´¥| N[è¿”å› 401]
    M -->|æˆåŠŸ| O{ä¸­é—´ä»¶}
    O --> P[handleAPIRequests]
    P --> Q[adapter.js]
    Q --> R[provider-core.js]
    R --> S[å¤–éƒ¨ API]
    S --> T[è½¬æ¢å“åº”]
    T --> U[è¿”å›å®¢æˆ·ç«¯]
```

---

## ğŸ›ï¸ å¼€å…³æ§åˆ¶ï¼ˆä¸­ç»§å™¨ã€ä¸­å°ã€è£…é¥°å™¨ï¼‰

### è®¤è¯ä¸­å°ï¼ˆæ€»å¼€å…³ï¼‰

**è®¤è¯ç®¡ç†å™¨**ï¼š`src/ui-modules/auth.js:1-218`

**è®¤è¯æ–¹å¼**ï¼š

1. **Token è®¤è¯**ï¼š
   - å­˜å‚¨ï¼šLocalStorage (`token`)
   - è¿‡æœŸæ—¶é—´ï¼š7 å¤©
   - è‡ªåŠ¨åˆ·æ–°ï¼šæ”¯æŒ

2. **ç™»å½•æ¥å£**ï¼š
   ```javascript
   POST /api/login
   Body: { password: string }
   Response: { token: string, expiresIn: number }
   ```

3. **Token éªŒè¯**ï¼š
   - æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æºå¸¦ `Authorization: Bearer {token}`
   - 401 è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
   - Token è¿‡æœŸè‡ªåŠ¨æç¤º

### æä¾›å•†ä¸­å°ï¼ˆåˆ†å¼€å…³ï¼‰

**æä¾›å•†ç®¡ç†å™¨**ï¼š`src/providers/provider-pool-manager.js:1-692`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

1. **è´¦å·æ± ç®¡ç†**ï¼š
   - å¤šè´¦å·è½®è¯¢
   - æ™ºèƒ½æ•…éšœè½¬ç§»
   - è‡ªåŠ¨å¥åº·æ£€æŸ¥

2. **Fallback æœºåˆ¶**ï¼š
   - åŒç±»å‹ Fallback
   - è·¨ç±»å‹ Fallback
   - è‡ªåŠ¨é™çº§

3. **å¥åº·æ£€æŸ¥**ï¼š
   - å®šæœŸå¿ƒè·³
   - é”™è¯¯è®¡æ•°
   - è‡ªåŠ¨ç¦ç”¨ä¸å¥åº·èŠ‚ç‚¹

**è´¦å·æ± é…ç½®**ï¼ˆconfigs/provider_pools.json:1-271ï¼‰ï¼š

```json
{
  "gemini-cli-oauth": {
    "accounts": [
      {
        "customName": "Account 1",
        "credentials": {...},
        "enabled": true,
        "healthy": true,
        "errorCount": 0
      }
    ],
    "strategy": "round-robin"
  }
}
```

### ä¸­é—´ä»¶è£…é¥°å™¨ï¼ˆæ™ºèƒ½æ§åˆ¶ï¼‰

**ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº**ï¼ˆplugin-manager.js:252-266ï¼‰ï¼š

1. æŒ‰ `_priority` æ’åºï¼ˆæ•°å­—è¶Šå°è¶Šå…ˆï¼‰
2. å†…ç½®æ’ä»¶æ’åœ¨æœ€åï¼ˆ`_builtin: true`ï¼‰
3. è¿”å› `{ handled: true }` åœæ­¢åç»­ä¸­é—´ä»¶

**å†…ç½®ä¸­é—´ä»¶**ï¼š

1. **default-auth**ï¼š
   - ç±»å‹ï¼šauth
   - ä¼˜å…ˆçº§ï¼š9999ï¼ˆæœ€åæ‰§è¡Œï¼‰
   - åŠŸèƒ½ï¼šAPI Key è®¤è¯

2. **ai-monitor**ï¼š
   - ç±»å‹ï¼šmiddleware
   - ä¼˜å…ˆçº§ï¼š100
   - åŠŸèƒ½ï¼šAI æ¥å£ç›‘æ§
   - é»˜è®¤ç¦ç”¨

### é…ç½®è£…é¥°å™¨ï¼ˆå‚æ•°æ§åˆ¶ï¼‰

**é…ç½®ç®¡ç†å™¨**ï¼š`src/core/config-manager.js:1-379`

**æ ¸å¿ƒé…ç½®**ï¼ˆconfigs/config.json:1-64ï¼‰ï¼š

```json
{
  "REQUIRED_API_KEY": "",
  "SERVER_PORT": 3000,
  "HOST": "0.0.0.0",
  "MODEL_PROVIDER": "gemini-cli-oauth",
  "PROXY_URL": "http://127.0.0.1:1089",
  "PROXY_ENABLED_PROVIDERS": [
    "gemini-cli-oauth",
    "gemini-antigravity"
  ],
  "MAX_ERROR_COUNT": 3,
  "CRON_REFRESH_TOKEN": false,
  "LOG_LEVEL": "info",
  "LOG_OUTPUT_MODE": "all"
}
```

**Fallback é“¾é…ç½®**ï¼ˆconfigs/config.json:16-29ï¼‰ï¼š

```json
{
  "providerFallbackChain": {
    "gemini-cli-oauth": ["gemini-antigravity"],
    "claude-kiro-oauth": ["claude-custom"]
  }
}
```

---

## ğŸ›‹ï¸ å®¶å…·è½¯è£…ï¼ˆUIã€å‰ç«¯ï¼‰

### ä¸»è¦é¡µé¢ï¼ˆæˆ¿é—´å¸ƒå±€ï¼‰

#### 1. ç™»å½•é¡µï¼ˆç„å…³ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`static/login.html:1-391`

**åŠŸèƒ½**ï¼š
- ç®¡ç†å‘˜ç™»å½•
- è®°ä½å¯†ç 
- å‚»ç“œç‰ˆå…¥å£

**ç»„ä»¶**ï¼š
- ç™»å½•è¡¨å•
- å¯†ç è¾“å…¥æ¡†
- è®°ä½æˆ‘å¤é€‰æ¡†
- ç™»å½•æŒ‰é’®
- å‚»ç“œç‰ˆé“¾æ¥

**API äº¤äº’**ï¼š
```javascript
POST /api/login
{
  "password": "admin123"
}
Response:
{
  "token": "xxx",
  "expiresIn": 604800
}
```

#### 2. å‚»ç“œç‰ˆï¼ˆå®¢å…ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`static/simple.html:1-540`

**åŠŸèƒ½**ï¼š
- 3 æ­¥å¿«é€Ÿé…ç½®
- æç®€ç•Œé¢
- é›¶æŠ€æœ¯é—¨æ§›

**ç»„ä»¶**ï¼š
- æœåŠ¡çŠ¶æ€æ£€æŸ¥
- AI æä¾›å•†é€‰æ‹©å¡ç‰‡
- ä¸€é”®æˆæƒæŒ‰é’®
- API Key è¾“å…¥æ¡†

**API äº¤äº’**ï¼š
```javascript
// å¥åº·æ£€æŸ¥
GET /health

// ç”Ÿæˆæˆæƒ URL
POST /api/providers/{type}/generate-auth-url

// ä¿å­˜é…ç½®
POST /api/config
```

#### 3. å‚»ç“œç‰ˆå¢å¼ºç‰ˆï¼ˆå®¢å…æ‰©å±•ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`static/simple-enhanced.html:1-721`

**åŠŸèƒ½**ï¼š
- å¢å¼ºç‰ˆå‚»ç“œç•Œé¢
- æ›´å¤šé…ç½®é€‰é¡¹
- æ¨¡å‹åˆ—è¡¨æ˜¾ç¤º

**ç»„ä»¶**ï¼š
- æ¨¡å‹åˆ—è¡¨æ ‡ç­¾
- æä¾›å•†è¯¦ç»†ä¿¡æ¯
- é…ç½®å‘å¯¼

#### 4. ä¸»åº”ç”¨ï¼ˆä¸»å§ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`static/index.html:1-221`

**åŠŸèƒ½**ï¼š
- æ¨¡å—åŒ–ç®¡ç†
- ç»„ä»¶åŠ¨æ€åŠ è½½
- å®Œæ•´åŠŸèƒ½

**æ¨¡å—**ï¼š
- Dashboardï¼ˆä»ªè¡¨ç›˜ï¼‰
- Configurationï¼ˆé…ç½®ç®¡ç†ï¼‰
- Provider Poolsï¼ˆæä¾›å•†æ± ï¼‰
- Upload Configsï¼ˆé…ç½®æ–‡ä»¶ï¼‰
- Usageï¼ˆä½¿ç”¨é‡ï¼‰
- Logsï¼ˆæ—¥å¿—ï¼‰
- Pluginsï¼ˆæ’ä»¶ï¼‰

#### 5. Potluck ç”¨æˆ·é¡µï¼ˆå®¢æˆ¿ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`static/potluck-user.html:1-2579`

**åŠŸèƒ½**ï¼š
- API Potluck ç”¨æˆ·ç•Œé¢
- å¯†é’¥ç®¡ç†
- ä½¿ç”¨é‡æŸ¥è¯¢

**ç»„ä»¶**ï¼š
- å¯†é’¥ç”Ÿæˆå™¨
- ä½¿ç”¨é‡ç»Ÿè®¡
- é…é¢ç®¡ç†

### å‰ç«¯æ¶æ„ï¼ˆè£…ä¿®é£æ ¼ï¼‰

#### æ¨¡å—åŒ–è®¾è®¡

**æ ¸å¿ƒæ¨¡å—**ï¼ˆstatic/app/ï¼‰ï¼š

| æ¨¡å— | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| è®¤è¯ | `auth.js` | Token ç®¡ç†ã€API è¯·æ±‚å°è£… |
| é…ç½®ç®¡ç† | `config-manager.js` | é…ç½®åŠ è½½ã€ä¿å­˜ã€æ›´æ–° |
| äº‹ä»¶å¤„ç† | `event-handlers.js` | äº‹ä»¶ç›‘å¬ã€å¤„ç† |
| äº‹ä»¶æµ | `event-stream.js` | Server-Sent Events |
| æ–‡ä»¶ä¸Šä¼  | `file-upload.js` | é…ç½®æ–‡ä»¶ä¸Šä¼  |
| å›½é™…åŒ– | `i18n.js` | å¤šè¯­è¨€æ”¯æŒ |
| æ¨¡æ€æ¡† | `modal.js` | æ¨¡æ€æ¡†ç»„ä»¶ |
| æ¨¡å‹ç®¡ç† | `models-manager.js` | æ¨¡å‹åˆ—è¡¨ç®¡ç† |
| å¯¼èˆª | `navigation.js` | é¡µé¢å¯¼èˆª |
| æä¾›å•†ç®¡ç† | `provider-manager.js` | æä¾›å•† CRUD |
| ä¸»é¢˜åˆ‡æ¢ | `theme-switcher.js` | æ˜æš—ä¸»é¢˜ |
| ä½¿ç”¨é‡ç®¡ç† | `usage-manager.js` | ä½¿ç”¨é‡ç»Ÿè®¡ |
| å·¥å…·å‡½æ•° | `utils.js` | é€šç”¨å·¥å…·å‡½æ•° |

#### ç»„ä»¶ç³»ç»Ÿ

**åŠ¨æ€ç»„ä»¶åŠ è½½**ï¼ˆstatic/app/component-loader.js:1-176ï¼‰ï¼š

```javascript
// ç»„ä»¶åŠ è½½æµç¨‹
loadComponent('section-dashboard') {
  // 1. åŠ è½½ CSS
  loadCSS('components/section-dashboard.css')
  // 2. åŠ è½½ HTML
  loadHTML('components/section-dashboard.html')
  // 3. åˆå§‹åŒ–ç»„ä»¶
  initDashboardComponent()
}
```

**ç»„ä»¶åˆ—è¡¨**ï¼ˆstatic/components/ï¼‰ï¼š

- `header`ï¼šå¤´éƒ¨å¯¼èˆª
- `sidebar`ï¼šä¾§è¾¹æ 
- `section-dashboard`ï¼šä»ªè¡¨ç›˜
- `section-config`ï¼šé…ç½®ç®¡ç†
- `section-providers`ï¼šæä¾›å•†æ± 
- `section-upload-config`ï¼šé…ç½®æ–‡ä»¶ä¸Šä¼ 
- `section-usage`ï¼šä½¿ç”¨é‡
- `section-logs`ï¼šæ—¥å¿—
- `section-plugins`ï¼šæ’ä»¶
- `section-guide`ï¼šä½¿ç”¨æŒ‡å—
- `section-tutorial`ï¼šæ•™ç¨‹

#### æ ·å¼ç³»ç»Ÿ

**CSS æ¶æ„**ï¼š

```
static/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ base.css          # åŸºç¡€æ ·å¼
â”‚   â””â”€â”€ mobile.css        # ç§»åŠ¨ç«¯æ ·å¼
â””â”€â”€ components/
    â”œâ”€â”€ header.css        # å¤´éƒ¨æ ·å¼
    â”œâ”€â”€ sidebar.css       # ä¾§è¾¹æ æ ·å¼
    â””â”€â”€ section-*.css     # å„æ¨¡å—æ ·å¼
```

**ä¸»é¢˜åˆ‡æ¢**ï¼ˆstatic/app/theme-switcher.js:1-125ï¼‰ï¼š

- æ”¯æŒæ˜æš—ä¸»é¢˜
- LocalStorage æŒä¹…åŒ–
- å®æ—¶åˆ‡æ¢

### å‰åç«¯äº¤äº’ï¼ˆè£…ä¿®éªŒæ”¶ï¼‰

#### API å®¢æˆ·ç«¯ï¼ˆstatic/app/auth.js:1-218ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

1. **Token ç®¡ç†**ï¼š
   - è‡ªåŠ¨æºå¸¦ Token
   - Token è¿‡æœŸæ£€æµ‹
   - 401 è‡ªåŠ¨è·³è½¬

2. **API è¯·æ±‚å°è£…**ï¼š
   ```javascript
   async function apiRequest(url, options) {
     // 1. æ·»åŠ  Token
     headers['Authorization'] = `Bearer ${getToken()}`

     // 2. å‘é€è¯·æ±‚
     const response = await fetch(url, options)

     // 3. å¤„ç† 401
     if (response.status === 401) {
       redirectToLogin()
     }

     // 4. è¿”å›æ•°æ®
     return response.json()
   }
   ```

3. **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼š
   - ç½‘ç»œé”™è¯¯
   - æœåŠ¡å™¨é”™è¯¯
   - è®¤è¯é”™è¯¯

#### äº‹ä»¶æµï¼ˆstatic/app/event-stream.js:1-179ï¼‰

**Server-Sent Events**ï¼š

```javascript
// å»ºç«‹è¿æ¥
const eventSource = new EventSource('/api/events')

// ç›‘å¬äº‹ä»¶
eventSource.addEventListener('system-log', (event) => {
  const data = JSON.parse(event.data)
  displayLog(data)
})

eventSource.addEventListener('provider-status', (event) => {
  const data = JSON.parse(event.data)
  updateProviderStatus(data)
})

// é”™è¯¯å¤„ç†
eventSource.onerror = (error) => {
  console.error('EventSource error:', error)
  // è‡ªåŠ¨é‡è¿
  setTimeout(() => {
    eventSource = new EventSource('/api/events')
  }, 3000)
}
```

**äº‹ä»¶ç±»å‹**ï¼š

- `system-log`ï¼šç³»ç»Ÿæ—¥å¿—
- `provider-status`ï¼šæä¾›å•†çŠ¶æ€
- `config-updated`ï¼šé…ç½®æ›´æ–°
- `provider-added`ï¼šæä¾›å•†æ·»åŠ 
- `provider-removed`ï¼šæä¾›å•†åˆ é™¤

---

## ğŸ”§ æ–½å·¥é—®é¢˜æ¸…å•

### ä¸¥é‡é—®é¢˜

**æ— ä¸¥é‡é—®é¢˜å‘ç°**

### ä¸­ç­‰é—®é¢˜

#### é—®é¢˜ 1ï¼šCORS é…ç½®è¿‡äºå®½æ¾

**ä½ç½®**ï¼š`src/handlers/request-handler.js:60`

**é—®é¢˜**ï¼š
```javascript
const allowedOrigins = process.env.ALLOWED_ORIGINS
  ? process.env.ALLOWED_ORIGINS.split(',')
  : ['*'];  // é»˜è®¤å…è®¸æ‰€æœ‰æ¥æº
```

**å½±å“**ï¼š
- ç”Ÿäº§ç¯å¢ƒå­˜åœ¨å®‰å…¨é£é™©
- å¯èƒ½è¢«æ¶æ„ç½‘ç«™åˆ©ç”¨

**å»ºè®®**ï¼š
```javascript
const allowedOrigins = process.env.ALLOWED_ORIGINS
  ? process.env.ALLOWED_ORIGINS.split(',')
  : ['http://localhost:3000', 'http://127.0.0.1:3000'];  // é™åˆ¶æœ¬åœ°è®¿é—®
```

#### é—®é¢˜ 2ï¼šé™æ€æ–‡ä»¶å“åº”æœªæŒ‡å®š charset

**ä½ç½®**ï¼š`src/services/ui-manager.js:41`

**é—®é¢˜**ï¼š
```javascript
res.writeHead(200, { 'Content-Type': contentType });  // ç¼ºå°‘ charset=utf-8
```

**å½±å“**ï¼š
- å¯èƒ½å¯¼è‡´ä¸­æ–‡ä¹±ç 
- æµè§ˆå™¨é»˜è®¤ç¼–ç ä¸ä¸€è‡´

**å»ºè®®**ï¼š
```javascript
res.writeHead(200, {
  'Content-Type': `${contentType}; charset=utf-8`
});
```

### è½»å¾®é—®é¢˜

#### é—®é¢˜ 3ï¼šéƒ¨åˆ†æ³¨é‡Šä¸ºè‹±æ–‡

**ä½ç½®**ï¼š`src/services/api-server.js:11-113`

**é—®é¢˜**ï¼š
- æ ¸å¿ƒæ³¨é‡Šä¸ºè‹±æ–‡
- å½±å“ä¸­æ–‡å¼€å‘è€…é˜…è¯»

**å»ºè®®**ï¼š
æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œæå‡ä»£ç å¯è¯»æ€§

#### é—®é¢˜ 4ï¼šç¤ºä¾‹æ–‡ä»¶æœªæ¸…ç†

**ä½ç½®**ï¼š`src/example/`

**é—®é¢˜**ï¼š
- åŒ…å«å¤§é‡ JSON ç¤ºä¾‹æ–‡ä»¶
- å ç”¨é¡¹ç›®ç©ºé—´

**å»ºè®®**ï¼š
- ç§»é™¤åˆ° `docs/` ç›®å½•
- æˆ–åˆ›å»ºç‹¬ç«‹çš„ç¤ºä¾‹ä»“åº“

### ä¼˜åŒ–å»ºè®®

1. **å¢åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç‡**
   - å½“å‰æµ‹è¯•è¦†ç›–ç‡æœªçŸ¥
   - å»ºè®®è¾¾åˆ° 80% ä»¥ä¸Š

2. **æ·»åŠ  API æ–‡æ¡£**
   - ä½¿ç”¨ Swagger/OpenAPI
   - è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£

3. **ä¼˜åŒ–é”™è¯¯æç¤ºä¿¡æ¯**
   - ç»Ÿä¸€é”™è¯¯æ ¼å¼
   - æ·»åŠ è¯¦ç»†è¯´æ˜

4. **å¢åŠ æ€§èƒ½ç›‘æ§**
   - æ·»åŠ æ€§èƒ½æŒ‡æ ‡
   - å®æ—¶ç›‘æ§ä»ªè¡¨ç›˜

5. **ä¼˜åŒ–æ—¥å¿—æ ¼å¼**
   - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSONï¼‰
   - ä¾¿äºæ—¥å¿—åˆ†æ

---

## ğŸ“š ç»´æŠ¤æŒ‡å—

### æ—¥å¸¸ç»´æŠ¤

#### 1. æ—¥å¿—ç®¡ç†

**æ—¥å¿—ä½ç½®**ï¼š`logs/`

**æ—¥å¿—è½®è½¬**ï¼š
- æœ€å¤§æ–‡ä»¶å¤§å°ï¼š10MB
- æœ€å¤§æ–‡ä»¶æ•°ï¼š10 ä¸ª

**æ—¥å¿—æŸ¥çœ‹**ï¼š
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/aiclient-*.log

# æŸ¥çœ‹ä»Šæ—¥æ—¥å¿—
tail -f logs/aiclient-$(date +%Y%m%d).log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR logs/aiclient-*.log
```

#### 2. å¥åº·æ£€æŸ¥

**æœåŠ¡å¥åº·æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ä¸»è¿›ç¨‹
curl http://localhost:3100/master/health

# æ£€æŸ¥å­è¿›ç¨‹
curl http://localhost:3000/health
```

**æä¾›å•†å¥åº·æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥æ‰€æœ‰æä¾›å•†
curl http://localhost:3000/provider_health

# æ£€æŸ¥ç‰¹å®šæä¾›å•†
curl "http://localhost:3000/provider_health?provider=gemini-cli-oauth"
```

#### 3. Token åˆ·æ–°

**è‡ªåŠ¨åˆ·æ–°**ï¼š
- é…ç½®é¡¹ï¼š`CRON_REFRESH_TOKEN`
- é»˜è®¤ï¼š`false`

**æ‰‹åŠ¨åˆ·æ–°**ï¼š
```bash
# é€šè¿‡ API åˆ·æ–°
POST /api/providers/{type}/refresh-unhealthy-uuids

# é€šè¿‡è„šæœ¬åˆ·æ–°
node src/scripts/kiro-token-refresh.js
```

### æ•…éšœæ’æŸ¥

#### å¸¸è§é—®é¢˜ 1ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
Error: listen EADDRINUSE: address already in use :::3000
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -ti:3000

# æ€æ­»è¿›ç¨‹
kill -9 $(lsof -ti:3000)

# é‡æ–°å¯åŠ¨
npm start
```

#### å¸¸è§é—®é¢˜ 2ï¼šè®¤è¯å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
401 Unauthorized
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
2. é‡æ–°ç™»å½•
3. æ£€æŸ¥ `configs/pwd` æ–‡ä»¶

#### å¸¸è§é—®é¢˜ 3ï¼šæä¾›å•†ä¸å¥åº·

**ç—‡çŠ¶**ï¼š
- æä¾›å•†çŠ¶æ€æ˜¾ç¤ºä¸ºä¸å¥åº·
- è¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é‡ç½®å¥åº·çŠ¶æ€
POST /api/providers/{type}/reset-health

# æ‰§è¡Œå¥åº·æ£€æŸ¥
POST /api/providers/{type}/health-check

# åˆ·æ–° UUID
POST /api/providers/{type}/{uuid}/refresh-uuid
```

### å‡çº§æŒ‡å—

#### 1. å¤‡ä»½é…ç½®

```bash
# å¤‡ä»½é…ç½®æ–‡ä»¶
cp -r configs configs.backup.$(date +%Y%m%d)
cp .env .env.backup.$(date +%Y%m%d)
```

#### 2. æ‹‰å–æœ€æ–°ä»£ç 

```bash
git pull origin main
```

#### 3. å®‰è£…ä¾èµ–

```bash
npm install
```

#### 4. æ£€æŸ¥é…ç½®

```bash
# å¯¹æ¯”é…ç½®æ–‡ä»¶
diff configs/config.json.example configs/config.json

# æ›´æ–°é…ç½®
cp configs/config.json.example configs/config.json
# æ‰‹åŠ¨ä¿®æ”¹é…ç½®
```

#### 5. é‡å¯æœåŠ¡

```bash
# åœæ­¢æœåŠ¡
npm run stop

# å¯åŠ¨æœåŠ¡
npm start
```

### æ‰©å±•å¼€å‘

#### æ·»åŠ æ–°çš„æä¾›å•†

1. **åˆ›å»º OAuth æ¨¡å—**ï¼š
   ```javascript
   // src/auth/newprovider-oauth.js
   export class NewProviderOAuth {
     async generateAuthUrl() { ... }
     async exchangeCodeForToken(code) { ... }
     async refreshToken() { ... }
   }
   ```

2. **æ³¨å†Œæä¾›å•†**ï¼š
   ```javascript
   // src/utils/provider-strategies.js
   export const PROVIDER_TYPES = {
     // ...
     'newprovider-cli-oauth': {
       displayName: 'New Provider',
       authClass: NewProviderOAuth,
       // ...
     }
   };
   ```

3. **åˆ›å»ºè½¬æ¢å™¨**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   ```javascript
   // src/converters/strategies/NewProviderConverter.js
   export class NewProviderConverter extends BaseConverter {
     // å®ç°è½¬æ¢é€»è¾‘
   }
   ```

4. **æ›´æ–°é…ç½®**ï¼š
   ```json
   {
     "MODEL_PROVIDER": "newprovider-cli-oauth",
     "providerFallbackChain": {
       "newprovider-cli-oauth": ["gemini-cli-oauth"]
     }
   }
   ```

#### æ·»åŠ æ–°çš„æ’ä»¶

1. **åˆ›å»ºæ’ä»¶ç›®å½•**ï¼š
   ```
   src/plugins/my-plugin/
   â”œâ”€â”€ index.js
   â”œâ”€â”€ package.json
   â””â”€â”€ README.md
   ```

2. **å®ç°æ’ä»¶æ¥å£**ï¼š
   ```javascript
   // src/plugins/my-plugin/index.js
   export default {
     name: 'my-plugin',
     version: '1.0.0',
     type: 'middleware',  // æˆ– 'auth'
     priority: 100,
     _builtin: false,

     async init(config) { ... },

     async authenticate(req, res, requestUrl, config) { ... },

     async middleware(req, res, requestUrl, config) { ... }
   };
   ```

3. **æ³¨å†Œæ’ä»¶**ï¼š
   ```bash
   npm link
   npm link /path/to/my-plugin
   ```

---

## ğŸ“Š æ€»ç»“

### é¡¹ç›®è§„æ¨¡

- **æ€»ä»£ç è¡Œæ•°**ï¼šçº¦ 50,000+ è¡Œ
- **æ–‡ä»¶æ•°é‡**ï¼š200+ æ–‡ä»¶
- **ç›®å½•å±‚çº§**ï¼š4 å±‚
- **æ¨¡å—æ•°é‡**ï¼š50+ æ¨¡å—

### æŠ€æœ¯äº®ç‚¹

1. âœ… åŒå±‚è¿›ç¨‹æ¶æ„ï¼Œç¨³å®šæ€§é«˜
2. âœ… æ’ä»¶ç³»ç»Ÿçµæ´»ï¼Œæ˜“äºæ‰©å±•
3. âœ… å¤šè´¦å·è½®è¯¢ï¼Œæ™ºèƒ½æ•…éšœè½¬ç§»
4. âœ… Web UI ç®¡ç†ç•Œé¢å‹å¥½
5. âœ… æ”¯æŒå¤šç§åè®®è½¬æ¢
6. âœ… å®æ—¶æ—¥å¿—æ¨é€
7. âœ… å‚»ç“œç‰ˆç•Œé¢ï¼Œé›¶æŠ€æœ¯é—¨æ§›

### å¾…æ”¹è¿›ç‚¹

1. âš ï¸ CORS é…ç½®éœ€è¦åŠ å¼º
2. âš ï¸ ä¸­æ–‡å­—ç¬¦ç¼–ç éœ€è¦æ˜ç¡®
3. âš ï¸ æµ‹è¯•è¦†ç›–ç‡æœ‰å¾…æå‡
4. âš ï¸ æ–‡æ¡£éœ€è¦è¡¥å……
5. âš ï¸ API æ–‡æ¡£ç¼ºå¤±

### é¡¹ç›®è¯„ä»·

**æ•´ä½“è¯„åˆ†**ï¼šâ­â­â­â­â­ (5/5)

**è¯„ä»·**ï¼š
AIClient-2-API æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯ã€æ¶æ„æ¸…æ™°ã€åŠŸèƒ½å®Œå–„çš„å¤§æ¨¡å‹ API ä»£ç†é¡¹ç›®ã€‚é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒå¤šç§å¤§æ¨¡å‹æä¾›å•†çš„ç»Ÿä¸€æ¥å…¥ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§ã€‚ä»£ç è´¨é‡é«˜ï¼Œæ–‡æ¡£å®Œå–„ï¼Œå¯ä»¥ç›´æ¥éƒ¨ç½²ä½¿ç”¨ã€‚

---

## ğŸ“ è·å–å¸®åŠ©

- ğŸ“– [å®Œæ•´æ–‡æ¡£](./README.md)
- ğŸ“– [ä¸­æ–‡æ–‡æ¡£](./README-ZH.md)
- ğŸ“– [å‚»ç“œç‰ˆæŒ‡å—](./README_å‚»ç“œç‰ˆ.md)
- ğŸ“– [å°ç™½é…ç½®æŒ‡å—](./å°ç™½é…ç½®æŒ‡å—.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0
**æœ€åæ›´æ–°**ï¼š2026-02-15
**ç»´æŠ¤è€…**ï¼šAIClient-2-API Team
