# 项目核心信息提炼表 - 完整版

## 1. 项目目标 (Project Goals)

### 核心目标
将仅限客户端使用的免费大模型 API（Gemini, Antigravity, Qwen Code, Kiro 等）转换为标准的 OpenAI 兼容接口，供第三方应用（Cherry-Studio, NextChat, Cline 等）调用。

### 关键价值
- **突破客户端限制**: 利用 OAuth 授权机制突破频率和配额限制
- **统一接口格式**: 标准化 OpenAI 兼容接口，零成本迁移
- **多协议互转**: 支持 OpenAI/Claude/Gemini 三大协议智能互转
- **高可用性**: 账号池管理、自动故障转移、99.9% 服务可用性

---

## 2. 已实现功能 (Implemented Features)

### 2.1 多模型支持

| 提供商 | 模型示例 | 认证方式 | 状态 |
|--------|---------|---------|------|
| **Gemini CLI** | gemini-2.5-pro-exp-03-25, gemini-2.5-flash-exp | OAuth | ✅ 稳定 |
| **Antigravity** | gemini-claude-opus-4.5, gemini-3.0-pro | OAuth | ✅ 稳定 |
| **Qwen Code** | qwen3-coder-plus | OAuth | ✅ 稳定 |
| **Kiro** | claude-opus-4.5, claude-sonnet-4.5 | OAuth | ✅ 稳定 |
| **OpenAI** | gpt-4o, gpt-4-turbo | API Key | ✅ 稳定 |
| **Claude** | claude-opus-4.5, claude-sonnet-4.5 | API Key | ✅ 稳定 |
| **iFlow** | gpt-4o, qwen-max, kimik2 | OAuth | ✅ 稳定 |
| **Codex** | codex-api-v1 | OAuth | ✅ 稳定 |
| **Ollama** | llama2, mistral, codellama | 本地 | ✅ 稳定 |

### 2.2 协议转换
- ✅ **OpenAI → Claude**: 自动转换请求格式
- ✅ **OpenAI → Gemini**: 自动转换流式响应
- ✅ **Claude → OpenAI**: 处理 Thinking 模式
- ✅ **Gemini → OpenAI**: 处理 Safety Filters

### 2.3 Web UI 管理

**前端架构**:
- **静态文件**: `static/` 目录（纯 HTML/ES Modules）
- **后端 API**: `src/ui-modules/` (Node.js 模块)
- **组件化设计**: 按功能拆分，动态加载

**功能模块**:
- **仪表盘** (`section-dashboard.html`): 实时状态监控
- **配置管理** (`section-config.html`): 在线配置编辑
- **提供商池** (`section-providers.html`): 账号池管理
- **日志查看** (`section-logs.html`): 实时日志流
- **插件管理** (`section-plugins.html`): 插件系统
- **使用统计** (`section-usage.html`): API 调用统计

**端口配置**:
| 端口 | 用途 | 协议 |
|------|------|------|
| 3000 | Web UI 主界面 | HTTP |
| 8085 | Gemini OAuth 回调 | HTTP |
| 8086 | Antigravity OAuth | HTTP |
| 8087 | iFlow OAuth | HTTP |
| 1455 | Codex OAuth | HTTP |
| 19876-19880 | Kiro OAuth | HTTP |

### 2.4 高级特性

#### 账号池管理
```json
{
  "providers": [
    {
      "type": "gemini-cli-oauth",
      "nodes": [
        {"credentialsFile": "./gemini1.json", "enabled": true},
        {"credentialsFile": "./gemini2.json", "enabled": true}
      ],
      "strategy": "round-robin",
      "healthCheck": true
    }
  ]
}
```

#### 故障转移 (Fallback)
```json
{
  "providerFallbackChain": {
    "gemini-cli-oauth": ["gemini-antigravity", "claude-custom"],
    "claude-kiro-oauth": ["claude-custom", "openai-custom"]
  }
}
```

#### OAuth 管理
- **Base64 凭据**: 直接嵌入配置文件
- **文件凭据**: 外部 JSON 文件路径
- **自动发现**: 扫描配置目录自动加载
- **Token 刷新**: 自动刷新过期 Token

#### 系统提示词
- **文件注入**: 从 `configs/input_system_prompt.txt` 读取
- **实时同步**: 支持热更新
- **模式选择**:
  - `overwrite`: 完全覆盖
  - `append`: 追加到末尾
  - `none`: 不注入

### 2.5 部署支持

**支持的部署方式**:
- ✅ **本地直连**: Shell 脚本自动化（一键部署.sh）
- ✅ **PM2**: 进程管理器部署
- ✅ **CloudStudio**: 云端开发环境适配
- ❌ Docker: 已移除（国内访问受限）

**一键部署特性**:
- 自动检测 Node.js 版本
- 依赖自动安装
- 端口冲突检测
- 健康检查验证

---

## 3. 待开发/优化需求 (Pending Requirements)

### 3.1 前端优化
- [ ] **视觉升级**: 用户界面视觉优化
- [ ] **响应式设计**: 移动端适配改进
- [ ] **加载优化**: 组件懒加载
- [ ] **错误提示**: 用户友好的错误信息

### 3.2 本地化改造
- [ ] **CDN 替换**: 检查并替换 `cdnjs.cloudflare.com`
- [ ] **资源本地化**: 将外部依赖下载到本地
- [ ] **网络适配**: 支持国内网络环境

### 3.3 模块解耦
- [ ] **接口标准化**: 统一模块间通信接口
- [ ] **依赖注入**: 减少硬编码依赖
- [ ] **配置集中**: 统一配置管理

### 3.4 API 完善
- [ ] **接口文档**: 完善 API 文档
- [ ] **类型定义**: TypeScript 类型支持
- [ ] **错误码**: 标准化错误响应

### 3.5 性能优化
- [ ] **连接池**: 优化 HTTP 连接池
- [ ] **缓存机制**: 响应缓存策略
- [ ] **并发控制**: 请求限流和降级

---

## 4. 已知问题与风险 (Known Issues & Risks)

### 4.1 稳定性问题
- ✅ **进程崩溃**: 已添加 `maxRestartAttempts: 10` 限制
- ⚠️ **内存泄漏**: 长时间运行可能存在内存增长
- ⚠️ **并发限制**: 高并发下可能超时

### 4.2 安全风险
- ✅ **硬编码凭据**: 已移除，改用环境变量
- ⚠️ **CORS 配置**: 默认允许所有来源（`*`）
- ⚠️ **API 密钥**: 可选配置，未强制要求

### 4.3 网络问题
- ⚠️ **代理依赖**: 某些提供商需要代理访问
- ⚠️ **Token 过期**: OAuth Token 需要定期刷新
- ⚠️ **速率限制**: 触发速率限制可能被封禁

---

## 5. 版本依赖 (Dependencies)

### 5.1 运行环境
- **Node.js**: >= 18.0.0 (推荐 20.x)
- **操作系统**: Linux, macOS, Windows
- **内存**: 最少 1GB RAM
- **磁盘**: 最少 1GB 可用空间

### 5.2 核心依赖

```json
{
  "dependencies": {
    "axios": "^1.7.0",           // HTTP 客户端
    "undici": "^7.0.0",          // 高性能 HTTP
    "ws": "^8.0.0",              // WebSocket
    "open": "^8.4.0",            // 自动打开浏览器
    "dotenv": "^16.0.0",         // 环境变量
    "http-proxy-agent": "^7.0.0", // HTTP 代理
    "https-proxy-agent": "^7.0.0", // HTTPS 代理
    "socks-proxy-agent": "^8.0.0", // SOCKS 代理
    "google-auth-library": "^9.0.0", // Google OAuth
    "form-data": "^4.0.0",       // 表单数据
    "uuid": "^9.0.0"             // UUID 生成
  },
  "devDependencies": {
    "jest": "^29.0.0",           // 测试框架
    "eslint": "^8.0.0"           // 代码检查
  }
}
```

### 5.3 构建工具
- ❌ **无 Webpack**: 不使用构建工具
- ❌ **无 Vite**: 不使用构建工具
- ✅ **原生 ESM**: 使用 ES Modules
- ✅ **静态文件**: 纯 HTML/CSS/JS

---

## 6. 核心 API 与路由 (Core APIs & Routes)

### 6.1 OpenAI 兼容接口

| 路径 | 方法 | 功能 | 兼容性 |
|------|------|------|--------|
| `/v1/chat/completions` | POST | 对话生成 | ✅ OpenAI |
| `/v1/models` | GET | 模型列表 | ✅ OpenAI |
| `/v1/completions` | POST | 文本补全 | ✅ OpenAI |
| `/v1/embeddings` | POST | 嵌入向量 | ✅ OpenAI |

### 6.2 Claude 兼容接口

| 路径 | 方法 | 功能 | 兼容性 |
|------|------|------|--------|
| `/v1/messages` | POST | 消息生成 | ✅ Claude |
| `/v1/messages/batches` | POST | 批量消息 | ✅ Claude |

### 6.3 Gemini 兼容接口

| 路径 | 方法 | 功能 | 兼容性 |
|------|------|------|--------|
| `/v1beta/models` | GET | 模型列表 | ✅ Gemini |
| `/v1beta/models/{model}:generateContent` | POST | 内容生成 | ✅ Gemini |
| `/v1beta/models/{model}:streamGenerateContent` | POST | 流式生成 | ✅ Gemini |

### 6.4 Ollama 兼容接口

| 路径 | 方法 | 功能 | 兼容性 |
|------|------|------|--------|
| `/ollama/api/chat` | POST | 聊天对话 | ✅ Ollama |
| `/ollama/api/tags` | GET | 模型标签 | ✅ Ollama |

### 6.5 Web UI 接口

| 路径 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `/api/login` | POST | 用户登录 | 密码 |
| `/api/providers` | GET | 获取提供商 | Token |
| `/api/config` | POST | 更新配置 | Token |
| `/api/logs` | GET | 获取日志 | Token |
| `/api/usage` | GET | 使用统计 | Token |
| `/api/plugins` | GET/POST | 插件管理 | Token |

### 6.6 系统接口

| 路径 | 方法 | 功能 | 说明 |
|------|------|------|------|
| `/health` | GET | 健康检查 | 无需认证 |
| `/version` | GET | 版本信息 | 无需认证 |

---

## 7. 架构设计 (Architecture)

### 7.1 进程架构

```
┌─────────────────────────────────────────┐
│         Master Process                  │
│   (src/core/master.js)                 │
│   - 进程生命周期管理                     │
│   - 监控和重启                          │
│   - IPC 通信                            │
└──────────────┬──────────────────────────┘
               │ fork
               ▼
┌─────────────────────────────────────────┐
│      Worker Process                    │
│   (src/services/api-server.js)         │
│   - HTTP 服务器                         │
│   - WebSocket 服务                     │
│   - API 路由处理                        │
└──────────────┬──────────────────────────┘
               │
       ┌───────┴────────┬────────────────┐
       ▼                ▼                ▼
┌──────────────┐  ┌──────────┐  ┌──────────────┐
│ Provider     │  │ Converter│  │  Strategy    │
│  Manager     │  │  Engine  │  │  Pattern     │
└──────────────┘  └──────────┘  └──────────────┘
```

### 7.2 模块组织

```
src/
├── core/                   # 核心模块
│   ├── master.js         # 主进程
│   ├── config-manager.js # 配置管理
│   └── plugin-manager.js # 插件管理
├── services/              # 服务层
│   ├── api-server.js     # API 服务器
│   ├── ui-manager.js     # UI 管理
│   └── service-manager.js # 服务管理
├── handlers/              # 请求处理器
│   ├── request-handler.js # 请求处理
│   └── response-handler.js # 响应处理
├── providers/             # 提供商适配器
│   ├── gemini/           # Gemini 适配
│   ├── claude/           # Claude 适配
│   └── openai/           # OpenAI 适配
├── converters/            # 协议转换器
│   ├── BaseConverter.js  # 基础转换器
│   └── strategies/       # 转换策略
├── auth/                 # 认证模块
│   ├── gemini-oauth.js   # Gemini OAuth
│   └── index.js          # 认证管理
├── ui-modules/           # UI 后端模块
│   ├── auth.js           # UI 认证
│   ├── config-api.js     # 配置 API
│   └── provider-api.js   # 提供商 API
└── utils/                # 工具函数
    ├── logger.js         # 日志工具
    └── common.js         # 通用工具
```

---

## 8. 待确认疑问点

### 8.1 前端源码位置
- ✅ **已确认**: 前端为纯静态文件（`static/` 目录）
- ✅ **已确认**: 后端通过 `src/ui-modules/` 提供数据 API
- ✅ **已确认**: 无构建工具，使用原生 ESM

### 8.2 本地化资源清单
- ✅ **已扫描**: 未发现 `esm.sh` CDN 引用
- ✅ **已扫描**: 发现 `cdnjs.cloudflare.com` 用于 FontAwesome
- ⚠️ **待确认**: 是否需要将 FontAwesome 下载到本地

### 8.3 接口完整性
- ✅ **已确认**: 无 `/api/spots` 接口
- ✅ **已确认**: 核心接口已在文档中列出
- ✅ **已确认**: 所有接口均有后端实现

---

## 9. 配置文件清单

| 文件 | 路径 | 说明 | 必需 |
|------|------|------|------|
| `.env` | 项目根 | 环境变量 | ✅ 是 |
| `config.json` | configs/ | 主配置文件 | ✅ 是 |
| `provider_pools.json` | configs/ | 提供商池配置 | ❌ 否 |
| `plugins.json` | configs/ | 插件配置 | ❌ 否 |
| `pwd` | configs/ | 密码文件 | ✅ 是 |
| `*_oauth_creds.json` | configs/ | OAuth 凭证 | ⚠️ 部分 |

---

## 10. 日志文件

| 文件 | 路径 | 说明 | 保留时间 |
|------|------|------|----------|
| `app-YYYY-MM-DD.log` | logs/ | 应用日志 | 10 天 |
| `error.log` | logs/ | 错误日志 | 30 天 |
| `access.log` | logs/ | 访问日志 | 30 天 |

---

## 11. 环境变量完整列表

| 变量名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `DEFAULT_PASSWORD` | string | - | 登录密码（必需） |
| `REQUIRED_API_KEY` | string | - | API 访问密钥 |
| `ALLOWED_ORIGINS` | string | * | CORS 来源 |
| `SERVER_PORT` | number | 3000 | 服务端口 |
| `SERVER_HOST` | string | 0.0.0.0 | 监听地址 |
| `GEMINI_OAUTH_CLIENT_ID` | string | - | Gemini 客户端 ID |
| `GEMINI_OAUTH_CLIENT_SECRET` | string | - | Gemini 客户端密钥 |
| `OPENAI_API_KEY` | string | - | OpenAI API 密钥 |
| `CLAUDE_API_KEY` | string | - | Claude API 密钥 |
| `HTTP_PROXY` | string | - | HTTP 代理 |
| `HTTPS_PROXY` | string | - | HTTPS 代理 |
| `LOG_LEVEL` | string | info | 日志级别 |
| `LOG_DIR` | string | logs | 日志目录 |
| `MAX_CONNECTIONS` | number | 100 | 最大连接数 |
| `REQUEST_TIMEOUT` | number | 30000 | 请求超时(ms) |

---

## 12. 快速开始命令

```bash
# 1. 克隆仓库
git clone https://github.com/4xiaxia/4x.git
cd 4x

# 2. 配置环境变量
cp .env.example .env
nano .env  # 编辑配置

# 3. 安装依赖
npm install

# 4. 启动服务
bash 一键部署.sh

# 5. 访问 Web UI
# http://localhost:3000
```

---

**文档版本**: 1.0.0
**更新日期**: 2026-02-15
**维护者**: 4xiaxia
